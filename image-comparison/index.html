<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸŒ¸ Pollinations.ai Image Model Comparison Tool</title>
    <link rel="icon" type="image/svg+xml" href="https://raw.githubusercontent.com/pollinations/pollinations/main/assets/logo.svg">
    <meta name="description" content="Compare AI image generation models side-by-side with Pollinations.ai. Test different models, scenes, and styles. Free tier available.">
    <meta name="keywords" content="AI image generation, image models, pollinations.ai, model comparison, AI art, stable diffusion, flux, free AI images">
    <meta name="author" content="Pollinations.ai">
    <meta name="robots" content="index, follow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pollinations.ai">
    <meta property="og:title" content="Pollinations.ai Image Model Comparison Tool">
    <meta property="og:description" content="Compare AI image generation models side-by-side. Test scenes, styles, and models with free tier.">
    <meta property="og:image" content="https://raw.githubusercontent.com/pollinations/pollinations/main/assets/logo.png">
    <meta property="og:site_name" content="Pollinations.ai">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://pollinations.ai">
    <meta property="twitter:title" content="Pollinations.ai Image Model Comparison Tool">
    <meta property="twitter:description" content="Compare AI image generation models side-by-side. Test scenes, styles, and models with free tier.">
    <meta property="twitter:image" content="https://raw.githubusercontent.com/pollinations/pollinations/main/assets/logo.png">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://pollinations.ai">
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .container {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      h1 {
        color: #333;
        margin-bottom: 10px;
      }
      .subtitle {
        color: #666;
        margin-bottom: 30px;
      }
      .test-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }
      .test-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
      }
      .test-card:hover {
        border-color: #667eea;
        transform: translateY(-2px);
      }
      .test-card h3 {
        margin-top: 0;
        color: #667eea;
      }
      .image-container {
        width: 100%;
        aspect-ratio: 1;
        background: #e9ecef;
        border-radius: 8px;
        overflow: hidden;
        margin: 15px 0;
        position: relative;
      }
      .image-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .image-container .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #666;
      }
      .image-container .error {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #dc3545;
        text-align: center;
      }
      .status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .status.pending {
        background: #ffc107;
        color: #000;
      }
      .status.loading {
        background: #17a2b8;
        color: #fff;
      }
      .status.success {
        background: #28a745;
        color: #fff;
      }
      .status.error {
        background: #dc3545;
        color: #fff;
      }
      .status.waiting {
        background: #fd7e14;
        color: #fff;
        animation: pulse 1s infinite;
      }
      .status.retrying {
        background: #6f42c1;
        color: #fff;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      .controls {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 30px;
      }
      .controls label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
      }
      .controls input,
      .controls select,
      .controls textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 15px;
        box-sizing: border-box;
      }
      .controls textarea {
        min-height: 80px;
        resize: vertical;
        font-family: inherit;
      }
      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s;
        font-weight: 600;
      }
      .btn:hover {
        transform: scale(1.05);
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .btn-secondary {
        background: #6c757d;
      }
      .btn-connect {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      }
      .btn-disconnect {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-top: 20px;
      }
      .stat-box {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }
      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #667eea;
      }
      .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
      }
      .log {
        background: #000;
        color: #0f0;
        padding: 15px;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        height: 200px;
        overflow-y: auto;
        margin-top: 20px;
      }
      .log-entry {
        margin: 2px 0;
      }
      .log-entry.error {
        color: #ff6b6b;
      }
      .log-entry.success {
        color: #51cf66;
      }
      .log-entry.info {
        color: #74c0fc;
      }
      .log-entry.warning {
        color: #ffc107;
      }
      .byop-section {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border: 2px solid #28a745;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .byop-section.connected {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border-color: #ffc107;
      }
      .byop-status {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 10px;
      }
      .byop-info {
        font-size: 14px;
        color: #333;
      }
      .byop-info strong {
        color: #28a745;
      }
      .prompt-section {
        background: #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .prompt-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 15px;
      }
      .prompt-preview {
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-top: 10px;
      }
      .prompt-preview label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
        display: block;
      }
      .autocomplete-input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 14px;
        box-sizing: border-box;
        background-color: white;
        transition: all 0.3s ease;
      }
      .autocomplete-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      .autocomplete-input::placeholder {
        color: #adb5bd;
      }
      .countdown {
        font-family: "Courier New", monospace;
        font-weight: bold;
        color: #fd7e14;
      }
      .retry-info {
        font-size: 11px;
        color: #666;
        margin-top: 5px;
      }
      @media (max-width: 768px) {
        .prompt-row {
          grid-template-columns: 1fr;
        }
        .stats {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div style="text-align: center; margin-bottom: 30px;">
        <img src="https://raw.githubusercontent.com/pollinations/pollinations/main/assets/logo-text.svg" alt="pollinations.ai" style="max-width: 300px; height: auto; margin-bottom: 10px;">
        <h1 style="margin-top: 10px;">ðŸŒ¸ Image Model Comparison Tool</h1>
        <p class="subtitle">Compare AI image generation models side-by-side</p>
      </div>

      <!-- BYOP Section -->
      <div class="byop-section" id="byopSection">
        <div class="byop-status">
          <div class="byop-info" id="byopInfo">
            <strong>Free Tier Mode</strong> - Using Pollinations free tier (rate limits apply)
          </div>
          <div>
            <button class="btn btn-connect" id="connectBtn" onclick="connectWithPollinations()">
              Connect with Pollinations
            </button>
            <button class="btn btn-disconnect" id="disconnectBtn" onclick="disconnectPollinations()" style="display: none;">
              Disconnect
            </button>
          </div>
        </div>
      </div>

      <!-- Prompt Controls -->
      <div class="prompt-section">
        <div class="prompt-row">
          <div>
            <label for="sceneInput">Scene:</label>
            <input type="text" id="sceneInput" list="sceneOptions" oninput="updatePrompt()" placeholder="Type or select a scene..." value="Mountain landscape at golden hour with dramatic clouds" class="autocomplete-input">
            <datalist id="sceneOptions">
              <option value="Mountain landscape at golden hour with dramatic clouds">
              <option value="Futuristic cyberpunk cityscape with neon lights">
              <option value="Japanese zen garden with koi pond and cherry blossoms">
              <option value="Underwater coral reef with tropical fish and sea turtles">
              <option value="Cozy Scandinavian cottage in winter with snow">
              <option value="Space station orbiting Earth with Milky Way background">
              <option value="Medieval castle on misty hilltop at sunrise">
              <option value="Tropical beach at sunset with palm trees">
              <option value="Ancient library with towering bookshelves and ladder">
              <option value="Mystical forest with bioluminescent plants and fireflies">
            </datalist>
          </div>
          <div>
            <label for="styleInput">Style:</label>
            <input type="text" id="styleInput" list="styleOptions" oninput="updatePrompt()" placeholder="Type or select a style..." value="photorealistic 8K highly detailed" class="autocomplete-input">
            <datalist id="styleOptions">
              <option value="photorealistic 8K highly detailed">
              <option value="oil painting impressionist style with visible brushstrokes">
              <option value="digital art vibrant colors and bold contrasts">
              <option value="watercolor soft and dreamy ethereal atmosphere">
              <option value="anime Studio Ghibli inspired whimsical style">
              <option value="cinematic dramatic lighting and composition">
              <option value="minimalist clean composition with negative space">
              <option value="3D render octane render cinematic">
              <option value="vintage photograph sepia tone nostalgic">
              <option value="fantasy art epic scale magical atmosphere">
            </datalist>
          </div>
        </div>
        <button class="btn btn-secondary" onclick="randomizePrompt()" style="margin-bottom: 15px;">
          Randomize Scene + Style
        </button>
        <div class="prompt-preview">
          <label>Final Prompt (editable):</label>
          <textarea id="prompt" placeholder="Select a scene and style above, or enter your own prompt...">Mountain landscape at golden hour with dramatic clouds, photorealistic 8K highly detailed</textarea>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="testAllBtn" onclick="testAllModels()">Test All Models</button>
        <button class="btn btn-secondary" id="clearBtn" onclick="clearAll()" style="margin-left: 10px">
          Clear
        </button>
        <button class="btn btn-secondary" id="cancelBtn" onclick="cancelAllRetries()" style="margin-left: 10px; display: none;">
          Cancel All Retries
        </button>
      </div>

      <div class="stats">
        <div class="stat-box">
          <div class="stat-value" id="totalTests">0</div>
          <div class="stat-label">Total Tests</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="successCount">0</div>
          <div class="stat-label">Successful</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="failCount">0</div>
          <div class="stat-label">Failed</div>
        </div>
        <div class="stat-box" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)">
          <div class="stat-value" id="totalCost" style="color: #856404">0</div>
          <div class="stat-label">Total Pollens</div>
        </div>
      </div>

      <div id="modelsInfo" style="margin: 20px 0; padding: 15px; background: #e9ecef; border-radius: 8px; display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <strong>Available Models:</strong>
          <div>
            <button onclick="selectAllModels()" style="background: #28a745; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; margin-right: 8px; font-size: 12px;">
              Select All
            </button>
            <button onclick="deselectAllModels()" style="background: #dc3545; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
              Deselect All
            </button>
          </div>
        </div>
        <div style="font-size: 12px; color: #666; margin-bottom: 10px">
          Click on a model tag to toggle selection. Selected models will be tested.
        </div>
        <div id="modelTags" style="margin-top: 10px"></div>
      </div>

      <div class="test-grid" id="testGrid"></div>

      <div class="log" id="log">
        <div class="log-entry">Ready to test! Select a scene and style, then click "Test All Models" to begin.</div>
      </div>

      <!-- Footer -->
      <footer style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #e9ecef; text-align: center;">
        <div style="margin-bottom: 20px;">
          <a href="https://pollinations.ai" target="_blank" rel="nofollow">
            <img src="https://img.shields.io/badge/Built%20with-Pollinations-8a2be2?style=for-the-badge&logo=data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20124%20124%22%3E%3Ccircle%20cx%3D%2262%22%20cy%3D%2262%22%20r%3D%2262%22%20fill%3D%22%23ffffff%22%2F%3E%3C%2Fsvg%3E&logoColor=white&labelColor=6a0dad" alt="Built With pollinations.ai" style="height: 28px;">
          </a>
        </div>
        <ul style="list-style: none; padding: 0; margin: 0; display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;">
          <li><a href="https://pollinations.ai" target="_blank" rel="nofollow" style="color: #667eea; text-decoration: none; font-weight: 600;">pollinations.ai</a></li>
          <li><a href="https://raw.githubusercontent.com/pollinations/pollinations/main/assets/logo.svg" target="_blank" rel="nofollow" style="color: #667eea; text-decoration: none;">Logo White</a></li>
          <li><a href="https://raw.githubusercontent.com/pollinations/pollinations/main/assets/logo-text.svg" target="_blank" rel="nofollow" style="color: #667eea; text-decoration: none;">Logo Text White</a></li>
        </ul>
        <p style="margin-top: 20px; font-size: 12px; color: #666;">
          Powered by <a href="https://pollinations.ai" target="_blank" rel="nofollow" style="color: #667eea;">pollinations.ai</a> - Free AI Image Generation API
        </p>
      </footer>
    </div>

    <script>
      const API_BASE_URL = "https://gen.pollinations.ai/image";
      const AUTH_BASE_URL = "https://enter.pollinations.ai";
      const DEFAULT_TIMEOUT = 90000; // 90 seconds default
      const MAX_RETRIES = 3;

      // State
      let testResults = { total: 0, success: 0, failed: 0, totalCost: 0 };
      let availableModels = [];
      let modelMetadata = {};
      let selectedModels = new Set();
      let userApiKey = null;
      let userProfile = null;
      let retryQueue = []; // { model, retriesLeft, retryAt, useFreeTier }
      let isProcessingQueue = false;
      let countdownIntervals = {}; // model -> intervalId

      // Scene and style options for randomization
      const sceneOptions = [
        "Mountain landscape at golden hour with dramatic clouds",
        "Futuristic cyberpunk cityscape with neon lights",
        "Japanese zen garden with koi pond and cherry blossoms",
        "Underwater coral reef with tropical fish and sea turtles",
        "Cozy Scandinavian cottage in winter with snow",
        "Space station orbiting Earth with Milky Way background",
        "Medieval castle on misty hilltop at sunrise",
        "Tropical beach at sunset with palm trees",
        "Ancient library with towering bookshelves and ladder",
        "Mystical forest with bioluminescent plants and fireflies"
      ];

      const styleOptions = [
        "photorealistic 8K highly detailed",
        "oil painting impressionist style with visible brushstrokes",
        "digital art vibrant colors and bold contrasts",
        "watercolor soft and dreamy ethereal atmosphere",
        "anime Studio Ghibli inspired whimsical style",
        "cinematic dramatic lighting and composition",
        "minimalist clean composition with negative space",
        "3D render octane render cinematic",
        "vintage photograph sepia tone nostalgic",
        "fantasy art epic scale magical atmosphere"
      ];

      // Initialize
      window.addEventListener("DOMContentLoaded", () => {
        loadModelsFromAPI();
        checkBYOPConnection();
        updatePrompt();
      });

      // Auto-test on load if URL has ?autotest
      if (window.location.search.includes("autotest")) {
        setTimeout(testAllModels, 2000);
      }

      // BYOP Functions
      function connectWithPollinations() {
        const redirectUrl = encodeURIComponent(window.location.href);
        window.location.href = `${AUTH_BASE_URL}/authorize?redirect_url=${redirectUrl}&permissions=profile,balance&models=flux,openai,gptimage&expiry=30`;
      }

      function disconnectPollinations() {
        localStorage.removeItem('pollinations_api_key');
        localStorage.removeItem('pollinations_key_expiry');
        userApiKey = null;
        userProfile = null;
        updateBYOPUI();
        log('Disconnected from Pollinations account', 'info');
      }

      function checkBYOPConnection() {
        // Check URL hash for API key (from OAuth redirect)
        const hash = window.location.hash.slice(1);
        const params = new URLSearchParams(hash);
        const apiKey = params.get('api_key');

        if (apiKey) {
          userApiKey = apiKey;
          localStorage.setItem('pollinations_api_key', apiKey);
          localStorage.setItem('pollinations_key_expiry', Date.now() + 30 * 24 * 60 * 60 * 1000); // 30 days
          // Clear hash from URL
          window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
          log('Connected to Pollinations account', 'success');
        } else {
          // Check localStorage
          const storedKey = localStorage.getItem('pollinations_api_key');
          const expiry = localStorage.getItem('pollinations_key_expiry');
          if (storedKey && expiry && Date.now() < parseInt(expiry)) {
            userApiKey = storedKey;
          } else {
            localStorage.removeItem('pollinations_api_key');
            localStorage.removeItem('pollinations_key_expiry');
          }
        }

        if (userApiKey) {
          fetchUserProfile();
        } else {
          updateBYOPUI();
        }
      }

      async function fetchUserProfile() {
        try {
          const response = await fetch(`${AUTH_BASE_URL.replace('enter', 'gen')}/account/profile`, {
            headers: { 'Authorization': `Bearer ${userApiKey}` }
          });
          if (response.ok) {
            userProfile = await response.json();
          }
        } catch (error) {
          console.error('Failed to fetch profile:', error);
        }
        updateBYOPUI();
      }

      function updateBYOPUI() {
        const section = document.getElementById('byopSection');
        const info = document.getElementById('byopInfo');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');

        if (userApiKey && userProfile) {
          section.classList.add('connected');
          connectBtn.style.display = 'none';
          disconnectBtn.style.display = 'inline-block';
          info.innerHTML = `
            <strong>Connected</strong> - Using your Pollinations account<br>
            <small>Tier: ${userProfile.tier || 'unknown'} | 
            <a href="${AUTH_BASE_URL}" target="_blank">View Dashboard</a></small>
          `;
        } else if (userApiKey) {
          section.classList.add('connected');
          connectBtn.style.display = 'none';
          disconnectBtn.style.display = 'inline-block';
          info.innerHTML = `<strong>Connected</strong> - Using your Pollinations account`;
        } else {
          section.classList.remove('connected');
          connectBtn.style.display = 'inline-block';
          disconnectBtn.style.display = 'none';
          info.innerHTML = `<strong>Free Tier Mode</strong> - Using Pollinations free tier (rate limits apply)`;
        }
      }

      // Prompt Functions
      function updatePrompt() {
        const scene = document.getElementById('sceneInput').value;
        const style = document.getElementById('styleInput').value;
        const promptField = document.getElementById('prompt');
        
        if (scene && style) {
          promptField.value = `${scene}, ${style}`;
        } else if (scene) {
          promptField.value = scene;
        } else if (style) {
          promptField.value = style;
        }
      }

      function randomizePrompt() {
        const randomScene = sceneOptions[Math.floor(Math.random() * sceneOptions.length)];
        const randomStyle = styleOptions[Math.floor(Math.random() * styleOptions.length)];
        
        document.getElementById('sceneInput').value = randomScene;
        document.getElementById('styleInput').value = randomStyle;
        updatePrompt();
        
        log('Randomized prompt generated', 'info');
      }

      // Logging
      function log(message, type = "info") {
        const logEl = document.getElementById("log");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logEl.appendChild(entry);
        logEl.scrollTop = logEl.scrollHeight;
      }

      // Stats
      function updateStats() {
        document.getElementById("totalTests").textContent = testResults.total;
        document.getElementById("successCount").textContent = testResults.success;
        document.getElementById("failCount").textContent = testResults.failed;
        document.getElementById("totalCost").textContent = testResults.totalCost.toFixed(2);
      }

      function getModelCost(model) {
        const metadata = modelMetadata[model] || {};
        if (metadata.pricing) {
          const pricing = metadata.pricing;
          return (
            pricing["completionImageTokens"] ||
            pricing["completionVideoTokens"] ||
            pricing["completionVideoSeconds"] ||
            pricing["completionAudioSeconds"] ||
            0
          );
        }
        return 0;
      }

      // Status and UI Updates
      function setStatus(model, status, message = "") {
        const statusEl = document.getElementById(`${model}-status`);
        const infoEl = document.getElementById(`${model}-info`);

        if (statusEl) {
          statusEl.className = `status ${status}`;
          statusEl.textContent = status;
        }

        if (infoEl && message) {
          infoEl.innerHTML = `<small>${message}</small>`;
        }
      }

      function setLoading(model) {
        const container = document.getElementById(`${model}-container`);
        if (container) {
          container.innerHTML = '<div class="loading">Generating image...</div>';
        }
        setStatus(model, "loading");
      }

      function setError(model, error) {
        const container = document.getElementById(`${model}-container`);
        if (container) {
          container.innerHTML = `<div class="error">${error}</div>`;
        }
        setStatus(model, "error");
        testResults.failed++;
        testResults.total++;
        updateStats();
        log(`${model}: FAILED - ${error}`, "error");
      }

      function setSuccess(model, duration, size) {
        testResults.success++;
        testResults.total++;
        const cost = getModelCost(model);
        testResults.totalCost += cost;
        updateStats();
        setStatus(model, "success", `${duration}ms | ${size} | ${cost} pollens`);
        log(`${model}: SUCCESS in ${duration}ms (cost: ${cost} pollens)`, "success");
      }

      function setWaiting(model, seconds, retryCount) {
        setStatus(model, "waiting", `Rate limited - retry in ${seconds}s (attempt ${retryCount}/${MAX_RETRIES})`);
        
        // Start countdown
        let remaining = seconds;
        const infoEl = document.getElementById(`${model}-info`);
        
        // Clear existing interval
        if (countdownIntervals[model]) {
          clearInterval(countdownIntervals[model]);
        }
        
        countdownIntervals[model] = setInterval(() => {
          remaining--;
          if (remaining <= 0) {
            clearInterval(countdownIntervals[model]);
            delete countdownIntervals[model];
          } else if (infoEl) {
            infoEl.innerHTML = `<small>Rate limited - retry in <span class="countdown">${remaining}s</span> (attempt ${retryCount}/${MAX_RETRIES})</small>`;
          }
        }, 1000);
      }

      // Retry Queue Management
      function queueRetry(model, retryAfter, useFreeTier = false) {
        const existingIndex = retryQueue.findIndex(r => r.model === model);
        if (existingIndex >= 0) {
          retryQueue[existingIndex].retryAt = Date.now() + retryAfter * 1000;
        } else {
          const retriesLeft = MAX_RETRIES;
          retryQueue.push({
            model,
            retriesLeft,
            retryAt: Date.now() + retryAfter * 1000,
            useFreeTier
          });
        }
        
        updateCancelButton();
        if (!isProcessingQueue) {
          processRetryQueue();
        }
      }

      function updateCancelButton() {
        const cancelBtn = document.getElementById('cancelBtn');
        cancelBtn.style.display = retryQueue.length > 0 ? 'inline-block' : 'none';
      }

      function cancelAllRetries() {
        retryQueue = [];
        Object.values(countdownIntervals).forEach(clearInterval);
        countdownIntervals = {};
        updateCancelButton();
        log('All pending retries cancelled', 'warning');
      }

      async function processRetryQueue() {
        if (isProcessingQueue || retryQueue.length === 0) return;
        
        isProcessingQueue = true;
        
        while (retryQueue.length > 0) {
          // Sort by retry time
          retryQueue.sort((a, b) => a.retryAt - b.retryAt);
          
          const now = Date.now();
          const nextRetry = retryQueue[0];
          
          if (nextRetry.retryAt > now) {
            // Wait until next retry is due
            await new Promise(resolve => setTimeout(resolve, nextRetry.retryAt - now));
          }
          
          // Remove from queue and retry
          retryQueue.shift();
          updateCancelButton();
          
          if (nextRetry.retriesLeft > 0) {
            await testModel(nextRetry.model, nextRetry.useFreeTier, nextRetry.retriesLeft);
          } else {
            setError(nextRetry.model, 'Max retries exceeded');
          }
        }
        
        isProcessingQueue = false;
      }

      // Main Test Function
      async function testModel(model, forceFreeTier = false, retriesLeft = MAX_RETRIES) {
        const prompt = document.getElementById("prompt").value || "a beautiful landscape";
        
        // Determine which API key to use
        let apiKey = null;
        if (!forceFreeTier && userApiKey) {
          apiKey = userApiKey;
        }
        
        setLoading(model);
        const startTime = performance.now();
        
        try {
          let url = `${API_BASE_URL}/${encodeURIComponent(prompt)}?width=400&height=400&model=${model}&nologo=true`;
          if (apiKey) {
            url += `&key=${apiKey}`;
          }
          
          log(`Testing ${model}${apiKey ? ' (with API key)' : ' (free tier)'}...`);
          
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), DEFAULT_TIMEOUT);
          
          const response = await fetch(url, { 
            signal: controller.signal,
            headers: {
              'Accept': 'image/*'
            }
          });
          
          clearTimeout(timeoutId);
          const duration = Math.round(performance.now() - startTime);
          
          // Handle rate limiting (429)
          if (response.status === 429) {
            let retryAfter = 60; // default 60s
            
            // Try to get retry info from response
            const retryHeader = response.headers.get('Retry-After');
            if (retryHeader) {
              retryAfter = parseInt(retryHeader);
            }
            
            // Try to parse JSON error for more info
            try {
              const errorData = await response.json();
              if (errorData.retry_after) {
                retryAfter = errorData.retry_after;
              }
              log(`${model}: Rate limited - ${errorData.message || 'Try again later'}`, 'warning');
            } catch (e) {
              log(`${model}: Rate limited - waiting ${retryAfter}s`, 'warning');
            }
            
            // If using API key and got rate limited, fallback to free tier
            if (apiKey && !forceFreeTier) {
              log(`${model}: Falling back to free tier...`, 'info');
              // Retry immediately with free tier
              await testModel(model, true, retriesLeft);
              return;
            }
            
            // Queue for retry
            if (retriesLeft > 0) {
              setWaiting(model, retryAfter, MAX_RETRIES - retriesLeft + 1);
              queueRetry(model, retryAfter, true);
            } else {
              setError(model, 'Rate limited - max retries exceeded');
            }
            return;
          }
          
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
          }
          
          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("image")) {
            throw new Error(`Invalid content type: ${contentType}`);
          }
          
          const blob = await response.blob();
          const imageUrl = URL.createObjectURL(blob);
          const size = (blob.size / 1024).toFixed(1) + " KB";
          
          const container = document.getElementById(`${model}-container`);
          container.innerHTML = `<img src="${imageUrl}" alt="${model} result" onclick="window.open('${imageUrl}', '_blank')" style="cursor: zoom-in;">`;
          
          setSuccess(model, duration, size);
        } catch (error) {
          if (error.name === 'AbortError') {
            setError(model, `Request timeout (${DEFAULT_TIMEOUT/1000}s exceeded)`);
          } else {
            setError(model, error.message);
          }
        }
      }

      async function testAllModels() {
        if (availableModels.length === 0) {
          await loadModelsFromAPI();
        }
        
        // Reset
        testResults = { total: 0, success: 0, failed: 0, totalCost: 0 };
        updateStats();
        document.getElementById("log").innerHTML = "";
        
        // Clear any existing retry queue
        retryQueue = [];
        Object.values(countdownIntervals).forEach(clearInterval);
        countdownIntervals = {};
        
        if (selectedModels.size === 0) {
          log("No models selected! Please select at least one model to test.", "error");
          return;
        }
        
        log(`Starting tests for ${selectedModels.size} selected models...`, "info");
        
        const estimatedCost = Array.from(selectedModels).reduce(
          (sum, model) => sum + getModelCost(model),
          0
        );
        log(`Estimated cost: ${estimatedCost.toFixed(2)} pollens`, "info");
        
        document.getElementById("testAllBtn").disabled = true;
        document.getElementById("testAllBtn").textContent = "Testing...";
        
        // Test models sequentially to avoid rate limits
        const modelsArray = Array.from(selectedModels);
        for (const model of modelsArray) {
          await testModel(model);
          // Small delay between requests to be nice to the API
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        document.getElementById("testAllBtn").disabled = false;
        document.getElementById("testAllBtn").textContent = "Test All Models";
        
        log(`Testing batch complete! ${testResults.success}/${testResults.total} successful`, "success");
      }

      // Model Selection
      async function loadModelsFromAPI() {
        log("Fetching available models from API...", "info");
        
        try {
          const response = await fetch("https://gen.pollinations.ai/image/models");
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const models = await response.json();
          availableModels = models.map(m => m.name || m.id).filter(Boolean);
          
          models.forEach(model => {
            if (model.name) {
              modelMetadata[model.name] = model;
            }
          });
          
          log(`Loaded ${availableModels.length} models from API`, "success");
          
          document.getElementById("modelsInfo").style.display = "block";
          selectedModels = new Set(availableModels);
          renderModelTags();
          generateTestCards();
        } catch (error) {
          log(`Failed to load models: ${error.message}`, "error");
          availableModels = ["flux", "gptimage", "zimage", "nanobanana"];
          selectedModels = new Set(availableModels);
          renderModelTags();
          generateTestCards();
        }
      }

      function renderModelTags() {
        const tagsContainer = document.getElementById("modelTags");
        tagsContainer.innerHTML = availableModels
          .map(model => {
            const isSelected = selectedModels.has(model);
            return `<span 
              onclick="toggleModel('${model}')" 
              style="display: inline-block; background: ${isSelected ? "#667eea" : "#ccc"}; color: white; padding: 4px 12px; border-radius: 20px; margin: 4px; font-size: 12px; cursor: pointer; user-select: none; text-decoration: ${isSelected ? "none" : "line-through"}; opacity: ${isSelected ? "1" : "0.6"};"
              title="Click to ${isSelected ? "deselect" : "select"}"
            >
              ${isSelected ? "âœ“" : "âœ—"} ${model}
            </span>`;
          })
          .join("");
      }

      function toggleModel(model) {
        if (selectedModels.has(model)) {
          selectedModels.delete(model);
          log(`Deselected: ${model}`, "info");
        } else {
          selectedModels.add(model);
          log(`Selected: ${model}`, "success");
        }
        renderModelTags();
        generateTestCards();
      }

      function generateTestCards() {
        const grid = document.getElementById("testGrid");
        
        availableModels.forEach(model => {
          const isSelected = selectedModels.has(model);
          const metadata = modelMetadata[model] || {};
          const description = metadata.description
            ? `<p style="font-size: 12px; color: #666; margin: 5px 0;">${metadata.description.substring(0, 100)}...</p>`
            : "";
          
          let pricingHtml = "";
          if (metadata.pricing) {
            const pricing = metadata.pricing;
            const cost =
              pricing["completionImageTokens"] ||
              pricing["completionVideoTokens"] ||
              pricing["completionVideoSeconds"] ||
              pricing["completionAudioSeconds"] ||
              0;
            
            if (cost > 0) {
              pricingHtml = `<div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                <strong style="color: #856404;">Cost: ${cost} pollens</strong>
              </div>`;
            }
          }
          
          let badgesHtml = "";
          if (metadata.paid_only) {
            badgesHtml += `<span style="display: inline-block; background: #dc3545; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-right: 4px;">PAID</span>`;
          } else {
            badgesHtml += `<span style="display: inline-block; background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-right: 4px;">FREE</span>`;
          }
          
          if (metadata.input_modalities && metadata.input_modalities.includes("image")) {
            badgesHtml += `<span style="display: inline-block; background: #17a2b8; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-right: 4px;">Image Input</span>`;
          }
          
          if (metadata.output_modalities && metadata.output_modalities.includes("video")) {
            badgesHtml += `<span style="display: inline-block; background: #6f42c1; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-right: 4px;">Video</span>`;
          }
          
          const existingCard = document.getElementById(`${model}-card`);
          
          if (existingCard) {
            existingCard.style.display = isSelected ? "block" : "none";
            return;
          }
          
          const card = document.createElement("div");
          card.className = "test-card";
          card.id = `${model}-card`;
          card.style.display = isSelected ? "block" : "none";
          card.style.cursor = "pointer";
          card.style.position = "relative";
          card.title = "Click to deselect this model";
          
          card.onclick = e => {
            if (e.target.tagName === "IMG") return;
            toggleModel(model);
          };
          
          const deselectBtn = `
            <div style="position: absolute; top: 8px; right: 8px; background: rgba(220, 53, 69, 0.9); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.2s;" 
                 onmouseover="this.style.transform='scale(1.1)'" 
                 onmouseout="this.style.transform='scale(1)'"
                 title="Deselect"
                 onclick="event.stopPropagation(); toggleModel('${model}');"
            >Ã—</div>
          `;
          
          card.innerHTML = `
            ${deselectBtn}
            <h3>${model}</h3>
            <div style="margin-bottom: 8px;">${badgesHtml}</div>
            ${description}
            ${pricingHtml}
            <span class="status pending" id="${model}-status">Pending</span>
            <div class="image-container" id="${model}-container">
              <div class="loading">Click "Test All Models" to start</div>
            </div>
            <div id="${model}-info"></div>
          `;
          grid.appendChild(card);
        });
      }

      function clearAll() {
        availableModels.forEach(model => {
          const container = document.getElementById(`${model}-container`);
          if (container) {
            container.innerHTML = '<div class="loading">Click "Test All Models" to start</div>';
          }
          const infoEl = document.getElementById(`${model}-info`);
          if (infoEl) infoEl.innerHTML = "";
          const statusEl = document.getElementById(`${model}-status`);
          if (statusEl) {
            statusEl.className = "status pending";
            statusEl.textContent = "Pending";
          }
        });
        
        // Clear countdowns
        Object.values(countdownIntervals).forEach(clearInterval);
        countdownIntervals = {};
        
        // Clear retry queue
        retryQueue = [];
        updateCancelButton();
        
        testResults = { total: 0, success: 0, failed: 0, totalCost: 0 };
        updateStats();
        document.getElementById("log").innerHTML =
          '<div class="log-entry">Ready to test! Select a scene and style, then click "Test All Models" to begin.</div>';
      }

      function selectAllModels() {
        availableModels.forEach(model => selectedModels.add(model));
        renderModelTags();
        generateTestCards();
        log("All models selected", "success");
      }

      function deselectAllModels() {
        selectedModels.clear();
        renderModelTags();
        generateTestCards();
        log("All models deselected", "info");
      }
    </script>
  </body>
</html>
